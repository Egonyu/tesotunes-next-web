{
  "project": "Music Platform - Artists & Songs Domain Reconciliation",
  "created_at": "2025-11-05T11:51:00Z",
  "scope": "Artists and Songs (Track) domain",
  
  "canonical_schemas": {
    "artists": {
      "canonical_model_name": "Artist",
      "canonical_table_name": "artists",
      "primary_key": "id",
      "primary_key_type": "bigIncrements",
      "migration_file": "2025_01_10_000002_create_user_system_tables.php",
      "model_file": "app/Models/Artist.php",
      
      "columns_in_migration_not_in_fillable": [
        {
          "column": "total_plays_cached",
          "type": "bigInteger",
          "issue": "Present in migration but NOT in model $fillable",
          "action": "ADD to model $fillable if needed by application logic, or DOCUMENT as read-only cache"
        },
        {
          "column": "total_revenue_cached",
          "type": "decimal(12,2)",
          "issue": "Present in migration but NOT in model $fillable",
          "action": "ADD to model $fillable if needed, or DOCUMENT as read-only cache"
        },
        {
          "column": "earnings_balance",
          "type": "decimal(12,2)",
          "issue": "Present in migration but NOT in model $fillable",
          "action": "ADD to model $fillable"
        },
        {
          "column": "payout_phone_number",
          "type": "string",
          "issue": "Present in migration but NOT in model $fillable",
          "action": "ADD to model $fillable"
        },
        {
          "column": "distribution_suspended",
          "type": "boolean",
          "issue": "Present in migration (consolidated from 2025_11_01_061411) but NOT in model $fillable",
          "action": "ADD to model $fillable and casts"
        }
      ],
      
      "columns_in_fillable_match_migration": [
        "user_id", "stage_name", "slug", "bio", "avatar", "cover_image",
        "is_verified", "is_trusted", "verification_status", "verified_at",
        "verified_by", "rejection_reason", "status", "can_upload",
        "monthly_upload_limit", "total_songs_count", "total_albums_count",
        "total_plays_count", "total_revenue", "followers_count",
        "stats_last_updated_at", "commission_rate", "auto_publish",
        "require_approval", "website_url", "social_links",
        "primary_genre_id", "influences", "career_start_year", "record_label"
      ],
      
      "recommended_canonical_columns": "All migration columns should be canonical. Add missing columns to $fillable."
    },
    
    "songs": {
      "canonical_model_name": "Song",
      "canonical_table_name": "songs",
      "primary_key": "id",
      "primary_key_type": "bigIncrements",
      "migration_file": "2025_01_10_000003_create_music_content_tables.php",
      "model_file": "app/Models/Song.php",
      
      "accessor_vs_db_column_discrepancies": [
        {
          "accessor_name": "audio_file",
          "returns": "audio_file_original",
          "issue": "Model has getDurationAttribute() accessor that returns $this->audio_file_original for backward compatibility",
          "db_column": "audio_file_original",
          "action": "DOCUMENT accessor pattern - this is intentional backward compatibility, NOT an inconsistency"
        },
        {
          "accessor_name": "duration",
          "returns": "duration_seconds",
          "issue": "Model has getDurationAttribute() accessor that returns $this->duration_seconds",
          "db_column": "duration_seconds",
          "action": "DOCUMENT accessor pattern - this is intentional backward compatibility, NOT an inconsistency"
        }
      ],
      
      "columns_missing_from_migration": [],
      
      "columns_in_fillable_not_using_canonical_names": [
        {
          "fillable_name": "audio_file",
          "actual_db_column": "audio_file_original",
          "issue": "Model $fillable includes 'audio_file' but DB has 'audio_file_original'",
          "action": "REMOVE 'audio_file' from $fillable, ensure only 'audio_file_original' is used"
        },
        {
          "fillable_name": "file_path",
          "actual_db_column": null,
          "issue": "Model $fillable includes 'file_path' but no such column exists in migration",
          "action": "REMOVE 'file_path' from $fillable - appears to be legacy"
        },
        {
          "fillable_name": "file_path_128",
          "actual_db_column": null,
          "issue": "Model $fillable includes 'file_path_128' but no such column exists in migration",
          "action": "REMOVE 'file_path_128' from $fillable - use 'audio_file_128' instead"
        },
        {
          "fillable_name": "file_path_320",
          "actual_db_column": null,
          "issue": "Model $fillable includes 'file_path_320' but no such column exists in migration",
          "action": "REMOVE 'file_path_320' from $fillable - use 'audio_file_320' instead"
        },
        {
          "fillable_name": "preview_path",
          "actual_db_column": null,
          "issue": "Model $fillable includes 'preview_path' but no such column exists in migration",
          "action": "REMOVE 'preview_path' from $fillable - use 'audio_file_preview' instead"
        },
        {
          "fillable_name": "duration",
          "actual_db_column": "duration_seconds",
          "issue": "Model $fillable includes 'duration' but DB column is 'duration_seconds'",
          "action": "REMOVE 'duration' from $fillable, use 'duration_seconds' only"
        },
        {
          "fillable_name": "unique_listeners",
          "actual_db_column": "unique_listeners_count",
          "issue": "Model $fillable includes 'unique_listeners' but DB has 'unique_listeners_count'",
          "action": "REMOVE 'unique_listeners' from $fillable"
        },
        {
          "fillable_name": "revenue",
          "actual_db_column": "revenue_generated",
          "issue": "Model $fillable includes 'revenue' but DB has 'revenue_generated'",
          "action": "REMOVE 'revenue' from $fillable"
        },
        {
          "fillable_name": "allow_downloads",
          "actual_db_column": "is_downloadable",
          "issue": "Model $fillable has both 'is_downloadable' AND 'allow_downloads' - migration only has 'is_downloadable'",
          "action": "REMOVE 'allow_downloads' from $fillable - use 'is_downloadable' only"
        },
        {
          "fillable_name": "credits",
          "actual_db_column": null,
          "issue": "Model $fillable includes 'credits' - migration has 'additional_credits' but not 'credits'",
          "action": "Verify if 'credits' column exists or should map to 'additional_credits'"
        },
        {
          "fillable_name": "local_genres",
          "actual_db_column": null,
          "issue": "Model $fillable includes 'local_genres' but no such column in migration",
          "action": "Migration comments suggest this was planned - ADD column or REMOVE from fillable"
        },
        {
          "fillable_name": "cultural_context",
          "actual_db_column": null,
          "issue": "Model $fillable includes 'cultural_context' but no such column in migration",
          "action": "ADD column to migration or REMOVE from fillable"
        }
      ],
      
      "columns_in_migration_match_fillable": [
        "user_id", "artist_id", "album_id", "title", "slug", "description", "lyrics",
        "audio_file_original", "audio_file_320", "audio_file_128", "audio_file_preview",
        "artwork", "waveform_data", "duration_seconds", "file_format", "file_size_bytes",
        "bitrate_original", "sample_rate", "audio_quality_score", "file_hash",
        "primary_genre_id", "track_number", "disc_number", "is_explicit",
        "primary_language", "languages_sung", "contains_local_language", "mood_tags",
        "status", "visibility", "is_downloadable", "is_streamable", "allow_comments",
        "price", "is_free", "currency", "distribution_status",
        "distribution_requested_at", "distributed_at", "distribution_platforms",
        "isrc_code", "upc_code", "master_ownership_percentage",
        "publishing_ownership_percentage", "rights_holders", "copyright_year",
        "copyright_holder", "license_type", "composer", "producer",
        "mixing_engineer", "mastering_engineer", "featured_artists",
        "additional_credits", "recording_date", "recording_location",
        "recording_studio", "play_count", "unique_listeners_count",
        "download_count", "like_count", "comment_count", "share_count",
        "average_completion_rate", "skip_count", "revenue_generated",
        "approved_at", "approved_by", "review_notes", "rejection_reason",
        "flagged_count", "moderation_notes", "release_date",
        "scheduled_publish_at", "published_at"
      ],
      
      "casts_using_wrong_column_names": [
        {
          "cast_key": "duration",
          "actual_db_column": "duration_seconds",
          "action": "ADD 'duration_seconds' => 'integer' to casts if not present"
        },
        {
          "cast_key": "unique_listeners",
          "actual_db_column": "unique_listeners_count",
          "action": "REMOVE 'unique_listeners' cast, ensure 'unique_listeners_count' is cast"
        },
        {
          "cast_key": "revenue",
          "actual_db_column": "revenue_generated",
          "action": "REMOVE 'revenue' cast, ensure 'revenue_generated' => 'decimal:2' is present"
        }
      ],
      
      "recommended_canonical_columns": "Migration columns are canonical. Remove legacy fillable entries that don't match DB columns."
    }
  },
  
  "summary_of_inconsistencies": {
    "critical_issues": [
      "Song model $fillable contains multiple non-existent columns (file_path, file_path_128, file_path_320, preview_path, duration, unique_listeners, revenue, allow_downloads, credits, local_genres, cultural_context)",
      "Artist model $fillable missing migration columns (total_plays_cached, total_revenue_cached, earnings_balance, payout_phone_number, distribution_suspended)"
    ],
    "moderate_issues": [
      "Accessor methods provide backward compatibility for 'duration' and 'audio_file' - these are INTENTIONAL and should be documented, not changed"
    ],
    "minor_issues": [
      "Model casts reference non-canonical names in some cases"
    ]
  },
  
  "action_plan": {
    "phase_1_model_corrections": {
      "description": "Update models to match migration schema exactly",
      "actions": [
        {
          "file": "app/Models/Artist.php",
          "changes": [
            "ADD 'total_plays_cached' to $fillable",
            "ADD 'total_revenue_cached' to $fillable",
            "ADD 'earnings_balance' to $fillable and $casts as 'decimal:2'",
            "ADD 'payout_phone_number' to $fillable",
            "ADD 'distribution_suspended' to $fillable and $casts as 'boolean'"
          ]
        },
        {
          "file": "app/Models/Song.php",
          "changes": [
            "REMOVE 'audio_file' from $fillable (use accessor only)",
            "REMOVE 'file_path', 'file_path_128', 'file_path_320', 'preview_path' from $fillable",
            "REMOVE 'duration' from $fillable (use accessor getDurationAttribute for backward compat)",
            "REMOVE 'unique_listeners' from $fillable (use 'unique_listeners_count')",
            "REMOVE 'revenue' from $fillable (use 'revenue_generated')",
            "REMOVE 'allow_downloads' from $fillable (use 'is_downloadable' only)",
            "DECIDE: Remove 'credits', 'local_genres', 'cultural_context' OR add columns to migration",
            "UPDATE $casts: remove 'duration', 'unique_listeners', 'revenue' - ensure 'duration_seconds', 'unique_listeners_count', 'revenue_generated' are present"
          ]
        }
      ]
    },
    
    "phase_2_consolidation_migration": {
      "description": "Create idempotent migration to add missing columns if they are needed",
      "required": "Only if we decide to keep 'credits', 'local_genres', 'cultural_context' in model",
      "migration_name": "2025_11_05_120000_consolidate_songs_missing_columns.php",
      "actions": [
        "IF keeping 'local_genres': ADD json column 'local_genres' to songs table",
        "IF keeping 'cultural_context': ADD text column 'cultural_context' to songs table",
        "IF keeping 'credits': Either rename 'additional_credits' OR clarify distinction"
      ]
    },
    
    "phase_3_code_search_and_refactor": {
      "description": "Find and update all code using non-canonical names",
      "actions": [
        "Search for '$song->audio_file =' assignments (should use $song->audio_file_original)",
        "Search for '$song->duration =' assignments (should use $song->duration_seconds)",
        "Search for '$song->revenue =' assignments (should use $song->revenue_generated)",
        "Update controllers, services, tests to use canonical DB column names"
      ]
    },
    
    "phase_4_documentation": {
      "description": "Document canonical naming and accessor patterns",
      "actions": [
        "CREATE docs/NAMING_CONVENTIONS.md",
        "DOCUMENT that 'duration' and 'audio_file' are accessor-only for backward compatibility",
        "ADD migration lint script to prevent future renames without approval"
      ]
    },
    
    "phase_5_testing": {
      "description": "Verify all changes work correctly",
      "actions": [
        "Run php artisan migrate:fresh --seed",
        "Run all tests: vendor/bin/phpunit",
        "Verify factories create valid records",
        "Test accessor backward compatibility"
      ]
    }
  },
  
  "references_to_verify": {
    "controllers": [
      "app/Http/Controllers/Api/Music/UploadController.php",
      "app/Http/Controllers/Api/MusicController.php",
      "app/Http/Controllers/Api/Mobile/MobileDownloadController.php",
      "app/Http/Controllers/Backend/Admin/BulkUploadController.php",
      "app/Http/Controllers/Backend/Admin/MusicController.php"
    ],
    "tests": [
      "tests/Unit/Models/SongTest.php (if exists)",
      "tests/Unit/Services/SongServiceTest.php",
      "tests/Feature/*"
    ],
    "services": [
      "app/Services/SongService.php"
    ]
  },
  
  "decision_required": {
    "question": "Should we add 'local_genres', 'cultural_context', and clarify 'credits' column to migration, or remove from model?",
    "recommendation": "REMOVE from model $fillable if not currently used in production. Can add later via new migration if needed.",
    "user_confirmation_needed": true
  }
}
